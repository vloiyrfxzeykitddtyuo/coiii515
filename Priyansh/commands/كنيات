module.exports.config = {
    name: "مراقبة",
    version: "1.0.0",
    hasPermssion: 1, // يتطلب صلاحيات المشرف
    credits: "عباس البغدادي",
    description: "مراقبة تغييرات الكنيات في المجموعة",
    commandCategory: "إدارة",
    usages: "مراقبة",
    cooldowns: 5,
    dependencies: {
        "fs-extra": ""
    }
};

// قائمة المجموعات التي يتم مراقبة الكنيات فيها
let monitoredThreads = [];

// التحقق من وجود ملف حفظ البيانات وتحميله
const fs = require("fs-extra");
const monitorPath = __dirname + "/cache/nicknameMonitor.json";

// تحميل البيانات المحفوظة مسبقًا
function loadMonitorData() {
    try {
        if (fs.existsSync(monitorPath)) {
            const data = fs.readFileSync(monitorPath, "utf8");
            monitoredThreads = JSON.parse(data);
        }
    } catch (error) {
        console.error("خطأ في تحميل بيانات المراقبة:", error);
    }
}

// حفظ البيانات
function saveMonitorData() {
    try {
        fs.writeFileSync(monitorPath, JSON.stringify(monitoredThreads, null, 4), "utf8");
    } catch (error) {
        console.error("خطأ في حفظ بيانات المراقبة:", error);
    }
}

// تحميل البيانات عند بدء تشغيل البوت
loadMonitorData();

module.exports.run = async({ api, event, args }) => {
    const { threadID, messageID } = event;
    
    // التحقق مما إذا كانت المجموعة قيد المراقبة بالفعل
    const threadIndex = monitoredThreads.indexOf(threadID);
    
    if (threadIndex === -1) {
        // إضافة المجموعة لقائمة المراقبة
        monitoredThreads.push(threadID);
        saveMonitorData();
        return api.sendMessage("✅ تم تفعيل مراقبة تغييرات الكنيات في هذه المجموعة بنجاح.", threadID, messageID);
    } else {
        // إزالة المجموعة من قائمة المراقبة
        monitoredThreads.splice(threadIndex, 1);
        saveMonitorData();
        return api.sendMessage("❌ تم إيقاف مراقبة تغييرات الكنيات في هذه المجموعة.", threadID, messageID);
    }
};

// مراقبة أحداث تغيير الكنية
module.exports.handleEvent = async({ api, event }) => {
    // التأكد من أن الحدث هو تغيير كنية
    if (event.type !== "change_thread_nickname") return;
    
    const { threadID, author, participantIDs, nickname } = event;
    
    // التحقق مما إذا كانت المجموعة قيد المراقبة
    if (!monitoredThreads.includes(threadID)) return;
    
    // الحصول على معلومات المستخدم الذي تم تغيير كنيته
    let targetUser = participantIDs[0];
    let targetName = "";
    
    try {
        // الحصول على اسم المستخدم الذي قام بتغيير الكنية
        const authorInfo = await api.getUserInfo(author);
        const authorName = authorInfo[author]?.name || "شخص ما";
        
        // الحصول على اسم المستخدم الذي تم تغيير كنيته
        const targetInfo = await api.getUserInfo(targetUser);
        targetName = targetInfo[targetUser]?.name || "شخص ما";
        
        let message = "";
        
        // إذا قام الشخص بتغيير كنيته الخاصة
        if (author === targetUser) {
            message = `⚠️ تنبيه: قام ${authorName} بتغيير كنيته إلى "${nickname || 'إزالة الكنية'}"`;
        } else {
            message = `⚠️ تنبيه: قام ${authorName} بتغيير كنية ${targetName} إلى "${nickname || 'إزالة الكنية'}"`;
        }
        
        // إرسال الإشعار في المجموعة
        return api.sendMessage(message, threadID);
    } catch (error) {
        console.error("خطأ في معالجة تغيير الكنية:", error);
    }
};
